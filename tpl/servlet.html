<h2><a name="welcome-to-github-pages" class="anchor" href="#welcome-to-github-pages"><span class="octicon octicon-link"></span></a>Servlet - JSP</h2>

<p>
Une servlet est un objet Java qui étend l'interface "Servlet" ou "HTTPServlet".<br/>
Cette interface définit 2 méthodes qui sont appelées lorsque le code est chargé/arrêté par le serveur web qui "expose" ces servlets à travers une URL.<br/>
Ces méthodes "init" et "destroy" permettent d'initialiser un certain nombre d'éléments au lancement de la servlet ou de nettoyer le contexte lors de leur arrêt.<br/>
</p>

<p>
Le serveur web va interpréter une partie de la requête HTTP envoyée par le navigateur de l'internaute et appeler une méthode de la servlet qui est responsable du traitement de cette requête.<br/>
</p>

<center><img src="https://img-19.ccm2.net/wog4vBWmS0Y-dT7QhNSHQ8D9JJ0=/ae3383290da84db58daee4b2ead60c81/ccm-encyclopedia/servlets-images-moteur.gif" /><br/>
  (source : "comment çà marche")
</center>

<p>
  C'est la méthode "service" qui est appelée.<br/>
  Cette méthode possède une implémentation par défaut dans la classe abstraite "<a href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpServlet.html">HTTPServlet</a>". Elle appelle la méthode doGet, doPost, doHead, doOptions, doPut, doTrace en fonction du type de requête HTTP reçu par le serveur.<br/>
</p>



<p>
  Les deux paramètres de ces opérations sont "<a href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpServletRequest.html">HTTPServletRequest</a>" et "<a href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpServletResponse.html">HTTPServletResponse</a>".<br/>
  Ils permettent respectivement d'analyser la requête émise par l'internaute, et de lui répondre.<br/>
</p>

<p>
La vidéo suivante présente le principe de fonctionnement des servlets.
</p>

<p align="center">
<iframe width="560" height="315" src="https://www.youtube.com/embed/F7TYXTyic60?rel=0" frameborder="0" allowfullscreen=""></iframe>
</p>

<p align="center">
<a href="https://www.fun-mooc.fr/asset-v1:Ulille+54005+session02+type@asset+block/1.2_servlet.pdf">Transparents présentés dans la vidéo</a>
</p>

<p>
  <strong>Utiliser Firebug</strong><br/>
  <a href="https://addons.mozilla.org/fr/firefox/addon/firebug/">
    <img src="http://www.nosyweb.fr/images/stories/article/outils/firebug_firefox.png" height="50" style="float: left; margin-right: 10px"> Firebug</a> est un plugin très pratique pour Firefox et vous devriez l'installer. Il permet de visualiser la structure HTML d'une page, de debugger du javascript, d'analyser les échanges réseaux, les cookies et bien d'autres choses.
</p>


<h2><a name="welcome-to-github-pages" class="anchor" href="#welcome-to-github-pages"><span class="octicon octicon-link"></span></a>Votre première servlet</h2>

<p>
  Nous allons réaliser une première servlet très simple en essayant de "tout faire à la main".<br/>
  Depuis l'écriture dans un éditeur de texte basique, la compilation et le lancement dans un serveur web de type "tomcat 8" allégé.
<p>

<p>
  <ul><li>
    Télécharger Tomcat extraire l'archive. Vous y trouverez un répertoire "webapps"
  </li><li>
    Rendez vous dans le dossier webapps et créez un répertoire tp1/WEB-INF/classes
  </li><li>
    Créez un ficher "MyServlet.java" à l'intérieur de classes
  </li></ul>
</p>

<code><pre>
  import java.io.IOException;
  import java.io.Writer;

  import javax.servlet.ServletException;
  import javax.servlet.annotation.WebServlet;
  import javax.servlet.http.HttpServlet;
  import javax.servlet.http.HttpServletRequest;
  import javax.servlet.http.HttpServletResponse;


  @WebServlet("/bonjour")
  public class MyServlet extends HttpServlet {

  	@Override
  	protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
  		String name = req.getParameter("nom");
  		if ( name == null || name.isEmpty() ) name = "tout le monde";

  		Writer out = resp.getWriter();
  		out.write("&lt;p&gt;Bonjour &lt;b&gt;&quot; + name + &quot;&lt;/b&gt; !&lt;/p&gt;");
  	}

  }
</pre></code>

<h3>Compilation</h3>

<p>
  Pour compiler ce code il faudra avoir le répertoire $JAVA_HOME/bin dans votre PATH (voir installation des outils). Il faut en effet pouvoir exécuter le compilateur "javac" facilement.<br/>
  Il sera également nécessaire de mettre la librairie "servlet-api.jar" dans votre CLASSPATH. Cette librairie contient toutes les interfaces et classes abstraites que nous implémentons en faisant des servlets.<br/>
  Elle est fournie (entre autre) avec Tomcat, dans le répertoire "lib".<br/>
</p>

<p>
  <code>javac -cp (chemin vers tomcat)/lib/servlet-api.jar MyServlet.java</code> <br/>
  Cela a du créer un fichier "MyServlet.class" qui est notre servlet, branchée sur l'url "/bonjour" du contexte "/tp1".<br/>
</p>

<h3>Déploiement</h3>

<p>
  Lançons notre serveur web.<br/>
  Rendez-vous dans le répertoire tomcat8/bin et exécutez <code>./catalina.sh run</code><br/>
  Après quelques secondes votre serveur est lancé et accessible sur "http://localhost:8080"<br/>
</p>

<p>
  Utilisez votre navigateur, puis la commande curl pour interroger votre servlet<br/>
  <code>curl -v http://localhost:8080/tp1/bonjour</code><br/>
</p>

<p>
  A. Essayez de passer votre nom en paramètre d'abord en GET.<br/>
  B. Modifier votre servlet pour n'accepter que le paramètre en POST. Tester à l'aide d'un formulaire écrit dans un fichier html sauvegardé n'importe où ... puis avec curl<br/>
  C.  Modifiez votre servlet pour afficher le formulaire sur le GET et pour afficher "bonjour xxx" lors d'un POST.<br/>
</p>

<h3>Screencast</h3>

<p>
Le screencast suivant illustre, par l'exemple, le développement d'une servlet.
</p>

<p align="center">
<iframe width="560" height="315" src="https://www.youtube.com/embed/55vkYR1JnZ4?rel=0" frameborder="0" allowfullscreen=""></iframe>
</p>

<p align="center">
<a href="https://github.com/gdufrene/mooc_jee_spring/raw/master/week1/screencast/sc05.zip">Code présenté dans le screencast</a>
</p>



<h2>Introduction aux JSP</h2>

<p>
JSP est un équivalent java des fichiers ASP ou PHP. C'est une manière de mettre du code Java, exécuté coté serveur, dans une page HTML. Le JSP n'est pas interprété, il est en fait traduit en Java puis compilé (généralement au premier appel de la page), et ensuite exécuté. C'est le résultat de cette exécution qui donne le code HTML renvoyé au navigateur.
</p>

<p>
Nous utiliserons "jasper" comme implémentation du moteur de JSP, il est fourni avec Tomcat.
</p>

<h3>Quelques bases</h3>

<p>
Afin de distinguer le code HTML ou JavaScript à donner au navigateur et le code Java à exécuter sur le serveur, nous utilisons les balises "&lt;%" et "%&gt;" pour délimiter le code Java. <br/>
Une balise particulière permet de définir des propriétés sur le type de réponse HTTP, l'encodage de la page, ou encore les imports Java nécessaires pour la compilation de la page. Toutes ces directives se retrouvent entre les balises "&lt;%@" et "%&gt;". <br/>
Enfin, il est très courant de vouloir afficher le contenu d'une variable dans le code HTML qui sera renvoyé au navigateur. Cela peut se faire en faisant un <code>&lt;% out.print( maVariable ); %&gt;</code> mais un tag a été défini pour réduire l'écriture à <code>&lt;%= maVariable %&gt;</code> qui fait exactement la même chose. <br/>
Comme nous sommes de bon développeurs consciencieux, nous n'hésiterons également pas à utiliser le tag permettant de mettre des commentaires dans nos JSP : <code>&lt;%-- mon super commentaire qui ne sera pas compilé ou envoyé au navigateur --%&gt;</code> <br/>
Il faut bien comprendre que la JSP va être traduite en code Java. Plus précisément en une classe qui hérite de Servlet dont il sera exécuté la méthode "service". Dans certains cas il peut être utile de vouloir introduire des attributs ou des méthodes à cette classe générée et compilée.<br/> 
Cela peut se faire avec le tag <code>&lt;%! private double montant; %&gt;</code>
</p>

<p>
Depuis votre code Java, vous pouvez utiliser les variables suivantes :
<ul><li>  request - qui contient l'objet HttpServletRequest
</li><li> response - qui contient l'objet HttpServletResponse
</li><li> out - qui est le flux de sorti équivalent à request.getWriter()
</li><li> application - un objet possédant notamment la méthode "log" utile pour débugger
</li><li> pageContext - un objet permettant d'échanger des variables entre les différents morceaux de jsp de la page.
</li></ul>
</p>

<p>
Pour rendre l'écriture de nos JSP un peu plus modulaire il est possible d'inclure du code JSP à partir d'une autre page JSP. Cela se fera via la directive &lt;%@ include file="ma_page.jsp" %&gt; Si vous donnez un chemin absolu au fichier (exemple /layout/header.jsp), la racine considérée est celle du contexte web du serveur. Il est ainsi plus facile d'être indépendant de l'environnement de déploiement.
</p>

<p>
  Il est également possible de traiter le début d'une requête avec une servlet et de déléguer l'affichage à une page JSP. Dans la servlet nous utiliserons alors <code>req.getRequestDispatcher("/ma/page.jsp").forward(req, resp)</code><br/>
  Pour passer des objets de la servlet à la JSP, il sera possible d'utiliser l'objet request et ses méthodes setAttribute / getAttribute.
</p>

<p>
  Il est alors possible de mettre en oeuvre un pattern MVC dont la partie "View" est traitée en JSP et la partie "Controller" est traitée par la servlet. Le modèle pourra quant à lui être cloisonné dans des classes d'accès au données (DAO) injectées dans le contrôleur.
</p>

<p>
La vidéo suivante présente le principe de fonctionnement des JSP.
</p>

<p align="center">
<iframe width="560" height="315" src="https://www.youtube.com/embed/Y4brBXyryhc?rel=0" frameborder="0" allowfullscreen=""></iframe>
</p>

<p align="center">
<a href="https://www.fun-mooc.fr/asset-v1:Ulille+54005+session02+type@asset+block/1.3_jsp.pdf">Transparents présentés dans la vidéo</a>.
</p>

<h3>Test</h3>

<p>
  Reprenez le contenu de <a href="https://raw.githubusercontent.com/gdufrene/java_ee_spring-13/master/102_Jsp/www/index.jsp">ce fichier</a> et mettez le dans un fichier "test.jsp", dans votre répertoire (tomcat) webapps/tp1.<br/>
  Accédez à la page http://localhost:8080/tp1/test.jsp</br>
  Le premier accès est un peu plus long car "jasper", le moteur jsp, transforme votre source jsp en source java, puis le compile et enfin il exécute ce code.<br/>
  Pour les appels suivants, le code est simplement exécuté comme n'importe quel autre servlet.<br/>
  Vous pouvez d'ailleurs consulter le contenu du source Java généré dans le répertoire de travail de Tomcat : <br/>
  <code>(tomcat) work/Catalina/localhost/tp1/org/apache/jsp</code><br/>
  Regarder le source peut aider à comprendre une erreur qui s'est glissée dans la JSP, ou à analyser une exception levée par le code exécuté.
</p>

<h3>Screencast</h3>

<p>
Le screencast suivant illustre, par l'exemple, le développement d'une servlet.
</p>

<p align="center">
<iframe width="560" height="315" src="https://www.youtube.com/embed/55vkYR1JnZ4?rel=0" frameborder="0" allowfullscreen=""></iframe>
</p>

<p align="center">
<a href="https://github.com/gdufrene/mooc_jee_spring/raw/master/week1/screencast/sc05.zip">Code présenté dans le screencast</a>
</p>
